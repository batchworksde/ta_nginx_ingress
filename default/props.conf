###
# Nginx Ingress Controller - Access Logs
###
[nginx:ingress:access]
KV_MODE = none
NO_BINARY_CHECK = true
CHARSET = UTF-8
TIME_PREFIX = \[
TIME_FORMAT = %d/%b/%Y:%H:%M:%S %z
MAX_TIMESTAMP_LOOKAHEAD = 32
disabled = false
pulldown_type = true
description = Nginx Ingress Controller access logs (Kubernetes)
category = Web

# Field Extractions
REPORT-nginx_ingress_access = nginx_ingress_access_extract

# HTTP Status Lookup
LOOKUP-nginx_ingress_httpstatus = nginx_ingress_httpstatus_lookup status OUTPUT status_description status_type status_description AS action

# CIM Field Aliases
FIELDALIAS-nginx_ingress_http_referrer = http_referer AS http_referrer

# Vendor/Product identification
EVAL-product = "Nginx Ingress Controller"
EVAL-vendor = "Kubernetes"
EVAL-vendor_product = "Kubernetes Nginx Ingress Controller"
EVAL-app = "nginx-ingress"

# Source IP
EVAL-src = src_ip

# User - null-coerce dash
EVAL-user = if(user=="-" OR isnull(user), null(), user)

# Bytes calculations
EVAL-bytes_in = request_length
EVAL-bytes = if(isnum(request_length), request_length, 0) + if(isnum(bytes_out), bytes_out, 0)

# Destination - parse upstream_addr into dest and dest_port
EVAL-dest = if(upstream_addr=="-" OR isnull(upstream_addr), null(), replace(upstream_addr, "^([^:]+):?\d*$", "\1"))
EVAL-dest_port = if(match(upstream_addr, ":\d+$"), replace(upstream_addr, "^[^:]+:(\d+)$", "\1"), null())

# Response time - convert seconds to milliseconds
EVAL-response_time = if(isnum(request_time), round(request_time * 1000, 3), null())

# URL construction
EVAL-url = uri_path . if(uri_query!="" AND uri_query!="-" AND isnotnull(uri_query), "?" . uri_query, "")
EVAL-url_length = len(uri_path . if(uri_query!="" AND uri_query!="-" AND isnotnull(uri_query), "?" . uri_query, ""))

# HTTP referrer domain extraction
EVAL-http_referrer_domain = case(match(http_referer, ":\/\/(\d+\.\d+\.\d+\.\d+):?\d{0,5}\/"), null(), http_referer=="-", null(), match(http_referer, "(?:[^:]+:\/\/([^:\/]+\.[^:\/\.]+)):?\d{0,5}\/.*"), replace(http_referer, "(?:[^:]+:\/\/([^:\/]+\.[^:\/\.]+)):?\d{0,5}\/.*", "\1"), true(), replace(http_referer, ".*:\/\/([^:\/]+\.?[^:\/]+):?\d{0,5}\/.*", "\1"))

# User agent length
EVAL-http_user_agent_length = len(http_user_agent)

# Status - null-coerce
EVAL-status = if(isnull(status) OR status=="-", null(), status)

# Upstream fields - null-coerce dashes
EVAL-upstream_response_time = if(upstream_response_time=="-" OR isnull(upstream_response_time), null(), upstream_response_time)
EVAL-upstream_status = if(upstream_status=="-" OR isnull(upstream_status), null(), upstream_status)

